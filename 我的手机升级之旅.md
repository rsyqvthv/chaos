# 我的手机升级之旅

> 将lineages os的老旧手机升级, 要保证所有的软件和数据最大程度的保留.




## 准备

- [android driver](https://download.highonandroid.com/file/Drivers/UniversalAdbDriverSetup.msi)
- [fastboot.zip](https://download.highonandroid.com/file/Tools/fastboot.zip)
- [Magisk Manager Canary 2020 APK](https://download.highonandroid.com/file/Tools/Magisk/Canary/MagiskManagerCanary2020.apk.html) (For Android 10)
- [Payload unpacker](https://download.highonandroid.com/file/Tools/Payload/payload_dumper-win64.zip.html)
- 检查手机的firmware版本, 到[这里](https://www.oneplus.com/uk/support/softwareupgrade)下载同样的版本, 确保数字部分是一样的.
- [OnePlus 5/5T](https://twrp.me/oneplus/oneplus5-5t.html) 准备相应的twrp



- 保证电脑手机链接通畅, debug模式遇到了obscuring problem, 解决方法 [via](https://stackoverflow.com/questions/52681145/because-an-app-is-obscuring-a-permissions-request-settings-cant-verify-your-re):

  - Go to Settings -> Apps -> Special Access -> Draw Over Other Apps

  - See which apps have permission to draw over other apps, and turn them off one by one until the problem goes away.

- 启动手机屏幕常亮. 

## 备份

- 启用飞行模式. 清除所有背后运行的软件(尽量).
- 用titanium backup备份. 将所有的user和system分组标记好. 然后备份所有的system和user数据. 
- 安装[Super Backup & Restore](https://apkpure.com/search?q=Super+Backup+%26+Restore), 备份calllogs.
- 简单清理一下internal盘, 比如删除tencent目录
- 将所有internal盘中的东西拷贝到电脑中.
  - 先将除了android目录外的盘拷贝.
  - 然后再拷贝android.这个目录计算时长需要很多时间. 注意把电脑的自动休眠关掉.

## 开始

一加5千万不要升级安卓10, 使用没有9流畅！ [via](https://www.oneplusbbs.com/thread-5512782-1.html)

## 遇到了问题

Just like you flash any other rom. [via](https://forums.oneplus.com/threads/how-can-i-flash-stock-rom-with-twrp.548862/)

开始进行

Clean Flash Recommended
Wipe **Dalvik, System, Data, and Cache**, 这里不应该清除system, 似乎.

- **双清**：先在recovery界面，点击清除，此时下面有个滑动恢复出厂设置，这就是双清。相当于进入高级清除，勾选data，cache；（所以这个步骤你点击高级清除勾选data与cache，效果与滑动是一样的）
- **四清**：是在双清基础上清空了dalvik cache（dalvik分区即虚拟内存）和system分区。 用户数据，系统残留都彻底清除，刷入的系统会更加稳定。（强调四清，会把原来的系统删掉，如果你刷机失败是没法进入原来的系统。**可以通过adb导包解决**）
- **五清**（即全清）：在上面勾选四个的情况下，再勾选内置存储。如果清除了，就需要重新导包，因为内置存储全部删掉。五清可以理解为手机里面的所有东西都基本删掉了，除了现在还在运行的recovery。整个手机重新来过。建议不要勾选，有时候会出现未知错误，建议顶多四清就可以了，已经很干净了。[via](https://www.zhihu.com/question/21168134)

Flash Stock Rom Beta/Stable
Flash Supersu/Magisk (If you need root)
Reboot System

- 但我在twrp中, 尝试刷zip, 提示no Digest File found.

- 这时看到Flash the latest official or the one by Check Your Screen. [via](https://forum.xda-developers.com/oneplus-x/help/flash-rom-digest-file-t3744288)

- **也许之前应该清除手机解锁密码?**

- 我下载了最新版的[twrp](https://dl.twrp.me/cheeseburger_dumpling/twrp-3.4.0-0-cheeseburger_dumpling.img.html), 但再也进入不了recovery了.

  - You might need to use the **unbrick tool.** This will return your phone to complete stock and will wipe your data. Next time, **use blu_spark instead of regular TWRP**. [via](https://forums.oneplus.com/threads/solved-stuck-in-fastboot-no-recovery.1016145/)
    - TWRP by mauronofrio: [Official Link](https://sourceforge.net/projects/mauronofrio-twrp/files/Cheeseburger-Dumpling/)
    - TWRP by poad42: [Official Link](https://sourceforge.net/projects/poad42/files/twrp/)
    - blu_spark TWRP by eng.stk: [Official Link](https://github.com/engstk/android_device_oneplus_cheeseburger/releases)
    - Official TWRP by Dees_Troy: [Official Link](https://dl.twrp.me/cheeseburger_dumpling/)**

- vol down + power能进入fastboot

- 尝试`fastboot flash recovery twrp.img`是一样的效果[via](https://nerdschalk.com/how-to-install-twrp-recovery-via-fastboot/), [via](https://twrp.me/oneplus/oneplus5-5t.html). 我对twrp挺失望.

- 目前想只好使用fastboot来安装原生系统

- [官方](http://downloads.oneplus.net/oneplus-5/oneplus_5_oxygenos_4.5.3/)现在也提供了*一加*5 氧OS的TWEP Rec(拉到页面最下面会看到 **Download Oxygen Recovey (Optional)** 字样).

- 成功救砖后，系统会恢复至Android 7.1.1。在这种状况下，直接刷Android 9.0.1完整升级包不会成功，得先升级到Android 8.0.1（或Android 8.1.0），然后利用系统自带的“**本地升级**”功能刷入Android 9.0.1完整升级包：成功。[via](https://www.eia543.com/?p=1604)

  - [【资源组】一加手机全系列⑮机型线刷救砖资源★附教程 - 资源共享 - 一加手机社区官方论坛](http://www.oneplusbbs.com/thread-4446250-1.html)
  - 使用这个刷机教程成功救砖.
  - [Windows 10系统如何强制禁用驱动程序签名（开启组策略）-联想知识库](https://iknow.lenovo.com.cn/detail/dc_132524.html) 虽然我没有用到这个, 但是留此存证.

- 这个可能是比较好的操作: Try sideloading your device with new ROM. [via](https://forum.xda-developers.com/oneplus-5/help/how-install-oxygen-os-adb-fastboot-t3664481/amp/) 正确的恢复原厂的方法. 其中对下面的方法有很多争议., 进入看详细的.

  > 需要有recovery, 可以执行 install from adb
  >
  > 并且android driver可用

  

  1. Dowload OxygenOS rom from official site *OnePlus* [http://downloads.*oneplus*.net/](http://downloads.oneplus.net/)
  2. Adb driver installed
  3. Put the file of the oxygenOs in adb folder , you can see this folder in C:
  4. Start the smartphone in recovery mode , now click install from adb
  5. From windows positioning on C folder , and start new session of prompt from adb folder ( you can do this, click shift on keyboard and while right click on adb folder , and you can see the option start new prompt command from folder)
  6. from the prompt you can put the command "adb devices" , for be sure the computer see your devices.
  7. Now you can install your rom , put the command "adb sideload filename.zip"

  Flashing stock recovery

  1. Download stock Recovery *OnePlus* from here [http://oxygenos.*oneplus*.net.s3.amazo...5_recovery.img](http://oxygenos.oneplus.net.s3.amazonaws.com/OP5_recovery.img) or else you can see on the download site of *oneplus*
  2. Copy the recovery in the adb folder
  3. Start a new prompt command from the folder adb
  4. Put the smartphone in fastboot mode (power off the smartphone , and click volume up + power)
  5. Put the command "fastboot device" for be sure computer can see the smartphone
  6. Put the command "fastboot flash recovery name-recovery.img"
  
- 临时加载`fastboot boot <img file name>`无效[via](https://aubykhan.wordpress.com/2013/07/21/android-tip-boot-into-twrp-or-cwm-recovery-without-flashing/), [via](https://forums.oneplus.com/threads/please-help-no-recovery-no-rom-and-twrp-install-not-working.1166107/)

- 如何得知变砖了的手机电量? [via](https://forum.xda-developers.com/showthread.php?t=1598336) 虽然这个是其他型号手机的操作, 但是似乎和我的一样. 保险起见就先这么搞吧.

  1. hold power button for 10 seconds to power the phone off
  2. power on with volume down held to enter Hboot
  3. press power button to enter Fastboot
  4. scroll down with volume down and select **Power Off**
  5. Plug you phone into the wall and you will see the red charging light come on, 红色是低电量. 白色是充电. 绿色可能是电满了.
  6. wait a few hours or until you get green light
  7. 中途可以点按电源键查看数值.

- 如何完全关闭手机?

- 刷机的时候将线链接到可以供电的插口. 不要放在面板前置的插口.

- 恢复了原生版本, 但是遇到了不能升级的问题, [via](https://forums.oneplus.com/threads/cannot-update-to-android-9-installation-failed.1120157/)

  - 建议是重新刷一个当前的版本, clean flash OOS 5.0.8, 也许是系统级别的某些更改并没有让当前的手机和原生一样.
  - Clean flash = wipe dalvik, cache, data; then install ROM (which will wipe system before it installs, or manually wipe system before the ROM install for good measure).
    Dirty flash = flash ROM, then wipe dalvik and cache. The only time you should do this if the ROM you're looking to flash says it can be done (ie. CM nightlies). [via](https://forum.xda-developers.com/oneplus-3/help/clean-flash-custom-rom-t3434905)

- 关于不能升级的问题, 我想到也许是线刷的包有问题, 所以我换了一个线刷包[via](http://www.oneplusbbs.com/thread-4446250-1.html), 虽然是氢系统, 但似乎可以升级了.

- 持续升级到9, 然后尝试按照教程[via](https://www.review-hub.co.uk/switch-oneplus-7-pro-hydrogen-to-oxygen-os/)刷入oxygen. 但教程有误, 不要在system update中升级, 而是在recovery中, 先reset setting后再升级. 

- 也能成功的升级到10beta [via](https://forums.oneplus.com/threads/oxygenos-android-10-open-beta-2-for-oneplus-5-5t.1221108/)

  - 各种rom的跟进 [via](https://nerdschalk.com/OnePlus-5-update/)
  
- 升级上去也能退回9, 使用recovery.

终于完结了. 奋战了26小时. 哈

## 在magisk的时候再次遇到问题. 

- 在电脑上配置好驱动和fastboot
- 并解开 Bootloader 锁 [via](https://oneplus.gadgethacks.com/how-to/unlock-bootloader-your-oneplus-6-0185473/)

如果你的设备有来自 [TWRP](https://twrp.me/Devices/) 的官方支持，只需在打开 USB 调试后将手机与电脑相连，然后打开电脑端的命令行窗口：

1. 执行 `adb reboot bootloader` 进入 Bootloader 界面
2. 执行 `fastboot boot TWRP.img` 进入临时 TWRP
3. 在 TWRP 中刷入你下载的 Magisk 安装包, 在安装的时候我却没有看到他备份原来的boot.img.

~~测试SafetyNet**出现了ctsProfile:false错误**.~~ 

如果是 **ctsProfile** 这一项没有通过，那说明你的 ROM 没有通过其兼容性测试，一些 beta 版本或者国内厂商的 ROM 可能出现这种问题。这时我们下载使用 [MagiskHide Props Config](https://forum.xda-developers.com/apps/magisk/module-magiskhide-props-config-t3789228) 这个模块往往能够解决问题。[via](https://sspai.com/post/53809)

If your device can't pass SafetyNet fully, the CTS profile check fails while basic integrity passes, that means MagiskHide is working on your device but Google doesn't recognise your device as being certified [via](https://github.com/Magisk-Modules-Repo/MagiskHidePropsConf/blob/master/README.md) 所以这个插件就是来伪装一个fingerprint

To fix this, you can use a known working device fingerprint (`ro.build.fingerprint`), one that has been certified by Google, usually from a stock ROM/firmware/factory image, and replace your device's current fingerprint with this. You can also use a fingerprint from another device, but this will change how your device is perceived.

If you're using a fingerprint for an Android build **after March 16th 2018** you might have to **change the security patch date** to one that matches the fingerprint used. 

> You can use the [Custom prop](https://github.com/Magisk-Modules-Repo/MagiskHide-Props-Config/blob/master/README.md#changeset-custom-prop-values) function of this module to change `ro.build.version.security_patch` to the desired date.
>
> The dates are always either the 1st or the 5th of the month, so try different months one after the other until the CTS profile passes.

After having applied a device fingerprint from the module, whenever that particular print is updated in the included prints list, the chosen fingerprint will be automatically updated when the fingerprints list is. Just reboot to apply the new fingerprint. 

找到了一些key和日期 [via](https://forum.xda-developers.com/apps/magisk/module-magiskhide-props-config-t3789228/post82826843#post82826843), [via](https://forum.xda-developers.com/search/thread/3789228?query=OnePlus5%3A9)

```
OnePlus/OnePlus5/OnePlus5:10/QKQ1.191014.012/2006012143:user/release-keys__2020-04-05

OnePlus/OnePlus5/OnePlus5:10/QKQ1.191014.012/2005122320:user/release-keys__2020-04-05

>>OnePlus/OnePlus5/OnePlus5:9/PKQ1.180716.001/2002242003:user/release-keys__2020-02-01

```

而我目前无法通过的key, 似乎和上面的一个一样, 是不是我在升级了android10并退回后, 造成了release date发生了改变?

```
OnePlus/OnePlus5/OnePlus5:9/PKQ1.180716.001/2002242003:user/release-keys
```

but if you enter a fingerprint manually you will **have to update the security patch date yourself** (if they don't already match). [via](https://github.com/Magisk-Modules-Repo/MagiskHidePropsConf/blob/master/README.md#run-options)

可以通过adb进行, 首次运行需要获取root权限:

```
adb shell
```

进入手机的shell后, 

You can use the [Custom prop](https://github.com/Magisk-Modules-Repo/MagiskHide-Props-Config/blob/master/README.md#changeset-custom-prop-values) function of this module to change `ro.build.version.security_patch` to the desired date. 但我实在不知道怎么单独更改日期.

~~props 我实在不知道怎么做.~~

再次尝试, 发现了他的提示说magisk hide没有启动. 后来才知道有setting [via](https://www.didgeridoohan.com/magisk/MagiskHide)

>  Enabled [MagiskHide](https://www.didgeridoohan.com/magisk/MagiskHide) (from Magisk v20.4 it is disabled by default).

而使用了这个就成功了, 不知道是不是MagiskHide Props Config的作用. 

~~那么再只好选择其他方法[via](https://www.mobile01.com/topicdetail.php?f=634&t=5686769), 说安装MagiskHide Props Config和[SafetyPatch](https://forum.xda-developers.com/apps/magisk/module-safetypatcher-t3809879), 可是后者不知道如何安装, 另外他的讨论帖子很少, 首页也没有什么安装介绍. [github](https://github.com/penn5/SafetyPatch) 页面也是什么都没有, 下载了zip也无法在magisk中安装.~~

尝试disable它之后再次重启. 仍然成功. 看样子原因是要**启动MagiskHide选项**!!

## 开始安装xposed

- 在Magisk管理器中刷入[Riru核心](https://github.com/RikkaApps/Riru/releases/download/v15/magisk-riru-core-v15.zip)
- 在Magisk管理器中刷入[EdXposed](https://github.com/ElderDrivers/EdXposed/releases/download/v0.2.9.9_b2/magisk-EdXposed-v0.2.9.9_beta2-release.zip), YAHFA is stable.
- 重启后安装[EdXposed管理器](https://github.com/ElderDrivers/EdXposed/releases/download/v0.2.9.9_b1/EdXposedInstaller_v2.2.0-release.apk)
- 打开之后确定是否成功安装
- 没意外会看到以下画面

再次遇到了问题. 开始在步骤完成后发现xposed manager提示红色.

这时saftynet检测全不过.

删除edxposedsaftynet通过.

尝试使用了sandhook版本, 仍然不行. 全部删除后, 发现即便没有核心和xposed, 也都不过.

在此基础上刷magisk也无用.

只好重头刷9.0, 尝试使用twrp刷, 遇到错误7, 不能刷. 幸好还可以回到原生recovery, 这里就可以刷. 这说明官方的包不是刷机格式的包.

按照要求一起刷, 安装apk后, xposed可以用了, 但是检测不过.

安装了MagiskManagerCanary2020, 发现了更高版本的magisk, 安装后. 装核心和xposed. 重启后进入logo循环.

再次尝试重启, 这回进去了. 但是仍然是双检不过.

这回去掉xposed yahfa, 重启后检测就可以了. 发现可能就是这个的问题. 而且不能使用sandhook.

不再纠结了.就当用个root的就好了.

[Announcement] No longer allowed to submit issues about SafetyNet · Issue #500 · ElderDrivers/EdXposed
https://github.com/ElderDrivers/EdXposed/issues/500

什么是SafetyNet？如何通过SafetyNet验证？ - 知乎
https://zhuanlan.zhihu.com/p/142714153

John Wu (@topjohnwu) / Twitter
https://twitter.com/topjohnwu

最后需要注意的是, edxposed安装模块的话要一个一个装, 不要一起装好多. 我恢复系统的时候就这样做, 造成了无法进入系统, 停留在小点儿转圈的画面. 解决的方法是强制重启, 过程中按着减少音量按键. 这时magisk在启动的时候不加载任何模块, 包括edxposed. 这样就可以进入系统了.

## oneplus launcher 3.5版本的recent app很残

[good lock](https://www.youtube.com/watch?v=b9o3kaoL_Ds)这里知道其实是可以根据launcher的功能. 但是尝试了其他的launcher, 比如nova, recent app都只是调用系统的.

[OnePlus Launcher 4.4.2 tweaks recent apps by removing buttons and adding an icon carousel](https://www.xda-developers.com/oneplus-launcher-4-4-2/) 新版的oneplus launcher是有优化的功能, 这再次说明了这是系统级别的改变. 其他launcher是无法做的.

然而我的android 9 无法安装, 显示解析错误. 

所以只能忍受目前的样子.

## 电话录音

其实oneplus内部是原生支持录音的, 但是我的可能由于地域的原因, 该功能被锁. 使用一个JOnePlus Tools 的工具就可以将其解开. 但是

- 问题是这个工具无法常驻, 重启后就退出了. 即便排除在电源优化也没有办法. 所以每次重启后要记住重新打开一下. 有时候忘记了就错过了录音.
- 也不知道什么原因, 录音文件原来可以直接调用recorder打开, 并且在其中显示列表. 后来也不知道为什么recorder调用后显示为空. 只能在其他的文件管理器中调用. 有些傻.

后来还是使用常用的true phone 2, + 他的magisk扩展. 录音效果几乎和原生一样. 

- 文件名称比较全面, 有名字, 电话和日期时间
- 格式是比较通用的
- 当然本身就没有播放界面, 但是由于文件通用, 可以使用mx player管理.

总算是解决了一个问题. 

这样原生phone app就可以冻结了.

